var TZ_LABELS=["UTC","Eastern (EST/EDT)","Central (CST/CDT)","Mountain (MST/MDT)","Pacific (PST/PDT)","Alaska (AKST/AKDT)","Hawaii (HST)"];
var showPage=function(p){var s=document.getElementById("statusPage"),g=document.getElementById("settingsPage");var ns=document.getElementById("navStatus"),ng=document.getElementById("navSettings");if(p==="settings"){s.style.display="none";g.style.display="block";ns.style.color="#8ba3c7";ng.style.color="#60a5fa";}else{s.style.display="block";g.style.display="none";ns.style.color="#60a5fa";ng.style.color="#8ba3c7";}};
document.getElementById("navStatus").onclick=function(){showPage("status");location.hash="status";return false;};
document.getElementById("navSettings").onclick=function(){showPage("settings");location.hash="settings";return false;};
if(location.hash==="#settings")showPage("settings");else showPage("status");
window.onhashchange=function(){if(location.hash==="#settings")showPage("settings");else showPage("status");};
document.getElementById("brightness").oninput=function(){document.getElementById("brightVal").textContent=this.value;};
var getSsid=function(){var s=document.getElementById("ssid").value;if(s)return s;return document.getElementById("ssidManual").value.trim();};
var doScan=function(){var st=document.getElementById("scanStatus");st.textContent="Scanning...";fetch("/scan").then(function(r){return r.json();}).then(function(nets){var sel=document.getElementById("ssid");sel.innerHTML="<option value=\"\">-- Select --</option>";nets.forEach(function(n){var o=document.createElement("option");o.value=n.ssid;o.text=n.ssid+" ("+n.rssi+" dBm)";sel.add(o);});st.textContent="Found "+nets.length;}).catch(function(){st.textContent="Scan failed";});};
var doTest=function(){var ssid=getSsid(),pw=document.getElementById("pw").value;if(!ssid){document.getElementById("msg").textContent="Select or enter SSID";return;}document.getElementById("msg").textContent="Testing...";var fd=new FormData();fd.append("ssid",ssid);fd.append("password",pw);fetch("/test",{method:"POST",body:fd}).then(function(r){return r.text();}).then(function(t){document.getElementById("msg").textContent=t;}).catch(function(){document.getElementById("msg").textContent="Test failed";});};
document.getElementById("ssid").onchange=function(){document.getElementById("ssidManual").value=this.value;};
document.getElementById("ssidManual").oninput=function(){document.getElementById("ssid").value="";};
var doSaveTz=function(){var fd=new FormData();fd.append("tz",document.getElementById("tz").value);fetch("/save_tz",{method:"POST",body:fd}).then(function(r){return r.text();}).then(function(t){document.getElementById("msg").textContent=t;});};
var doSaveBrightness=function(){var fd=new FormData();fd.append("brightness",document.getElementById("brightness").value);fetch("/save_brightness",{method:"POST",body:fd}).then(function(r){return r.text();}).then(function(t){document.getElementById("msg").textContent=t;});};
var loadStatus=function(){fetch("/api/status").then(function(r){return r.json();}).then(function(d){document.getElementById("deviceLabel").innerHTML="<b>"+escapeHtml(d.device_label||"Device")+"</b>";document.getElementById("settingsDeviceLabel").innerHTML="<b>"+escapeHtml(d.device_label||"Device")+"</b>";document.getElementById("ssidManual").value=d.saved_ssid||"";document.getElementById("brightness").value=d.brightness||42;document.getElementById("brightVal").textContent=d.brightness||42;document.getElementById("saveBtn").textContent=d.save_btn||"Save Settings";var tz=document.getElementById("tz");tz.innerHTML="";for(var i=0;i<TZ_LABELS.length;i++){var o=document.createElement("option");o.value=i;o.text=TZ_LABELS[i];if(i===(d.timezone_index||0))o.selected=true;tz.add(o);}}).catch(function(){});};
var escapeHtml=function(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML;};
var loadLive=function(){fetch("/api/readings").then(function(r){return r.json();}).then(function(d){var el=document.getElementById("liveReadings");el.innerHTML=d.valid?("Temp: "+d.temp_c+" C / "+d.temp_f+" F | Humidity: "+d.humidity_pct+" pct | Pressure: "+d.pressure_hpa+" hPa"):"No sensor data";}).catch(function(){document.getElementById("liveReadings").textContent="Failed to load";});};
var hChart=null;
var getHistoryRes=function(){var sel=document.getElementById("historyRes");return sel?sel.value:"hourly";};
var loadHistory=function(){var res=getHistoryRes();fetch("/api/history?res="+encodeURIComponent(res)).then(function(r){return r.json();}).then(function(arr){var valid=arr.filter(function(x){return x.valid;});var labels=valid.map(function(x){return new Date(x.timestamp*1000).toLocaleString();});if(hChart)hChart.destroy();var scale=1.6667;var pressNorm=valid.map(function(x){var p=(x.pressure_hpa-980)*scale;return Math.max(0,Math.min(100,p));});var ds1={label:"Temp C",data:valid.map(function(x){return x.temp_c;}),borderColor:"#ef4444",fill:false,tension:0.2};var ds2={label:"Humidity",data:valid.map(function(x){return x.humidity_pct;}),borderColor:"#3b82f6",fill:false,tension:0.2,yAxisID:"y1"};var ds3={label:"Pressure",data:pressNorm,borderColor:"#22c55e",fill:false,tension:0.2,yAxisID:"y1"};var opts={responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:50},y1:{position:"right",min:0,max:100}}};var cfg={type:"line",data:{labels:labels,datasets:[ds1,ds2,ds3]},options:opts};hChart=new Chart(document.getElementById("historyChart"),cfg);var tbody=document.getElementById("historyBody");tbody.innerHTML="";for(var i=Math.max(0,arr.length-24);i<arr.length;i++){var row=arr[i];if(!row.valid)continue;var dt=new Date(row.timestamp*1000);var txt=dt.toLocaleString();var tr=document.createElement("tr");tr.style.borderBottom="1px solid #2a3240";var td1=document.createElement("td");td1.style.padding="4px";td1.textContent=txt;var td2=document.createElement("td");td2.style.textAlign="right";td2.style.padding="4px";td2.textContent=row.temp_c;var td3=document.createElement("td");td3.style.textAlign="right";td3.style.padding="4px";td3.textContent=row.humidity_pct;var td4=document.createElement("td");td4.style.textAlign="right";td4.style.padding="4px";td4.textContent=row.pressure_hpa;tr.appendChild(td1);tr.appendChild(td2);tr.appendChild(td3);tr.appendChild(td4);tbody.appendChild(tr);}if(tbody.children.length===0){var tr=document.createElement("tr");var td=document.createElement("td");td.colSpan=4;td.textContent="No history yet";tr.appendChild(td);tbody.appendChild(tr);}}).catch(function(){var tbody=document.getElementById("historyBody");tbody.innerHTML="";var tr=document.createElement("tr");var td=document.createElement("td");td.colSpan=4;td.textContent="Failed to load";tr.appendChild(td);tbody.appendChild(tr);});};
var resEl=document.getElementById("historyRes");if(resEl)resEl.onchange=function(){loadHistory();};
loadStatus();loadLive();loadHistory();
setInterval(loadLive,5000);setInterval(loadHistory,60000);
