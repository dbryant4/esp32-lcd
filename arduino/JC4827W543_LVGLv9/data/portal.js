var TZ_LABELS=["UTC","Eastern (EST/EDT)","Central (CST/CDT)","Mountain (MST/MDT)","Pacific (PST/PDT)","Alaska (AKST/AKDT)","Hawaii (HST)"];
var showPage=function(p){var s=document.getElementById("statusPage"),g=document.getElementById("settingsPage");var ns=document.getElementById("navStatus"),ng=document.getElementById("navSettings");if(p==="settings"){s.style.display="none";g.style.display="block";ns.style.color="#8ba3c7";ng.style.color="#60a5fa";}else{s.style.display="block";g.style.display="none";ns.style.color="#60a5fa";ng.style.color="#8ba3c7";}};
document.getElementById("navStatus").onclick=function(){showPage("status");location.hash="status";return false;};
document.getElementById("navSettings").onclick=function(){showPage("settings");location.hash="settings";return false;};
if(location.hash==="#settings")showPage("settings");else showPage("status");
window.onhashchange=function(){if(location.hash==="#settings")showPage("settings");else showPage("status");};
document.getElementById("brightness").oninput=function(){document.getElementById("brightVal").textContent=this.value;};
var getSsid=function(){var s=document.getElementById("ssid").value;if(s)return s;return document.getElementById("ssidManual").value.trim();};
var doScan=function(){var st=document.getElementById("scanStatus");st.textContent="Scanning...";fetch("/scan").then(function(r){return r.json();}).then(function(nets){var sel=document.getElementById("ssid");sel.innerHTML="<option value=\"\">-- Select --</option>";nets.forEach(function(n){var o=document.createElement("option");o.value=n.ssid;o.text=n.ssid+" ("+n.rssi+" dBm)";sel.add(o);});st.textContent="Found "+nets.length;}).catch(function(){st.textContent="Scan failed";});};
var doTest=function(){var ssid=getSsid(),pw=document.getElementById("pw").value;if(!ssid){document.getElementById("msg").textContent="Select or enter SSID";return;}document.getElementById("msg").textContent="Testing...";var fd=new FormData();fd.append("ssid",ssid);fd.append("password",pw);fetch("/test",{method:"POST",body:fd}).then(function(r){return r.text();}).then(function(t){document.getElementById("msg").textContent=t;}).catch(function(){document.getElementById("msg").textContent="Test failed";});};
document.getElementById("ssid").onchange=function(){document.getElementById("ssidManual").value=this.value;};
document.getElementById("ssidManual").oninput=function(){document.getElementById("ssid").value="";};
var doSaveTz=function(){var fd=new FormData();fd.append("tz",document.getElementById("tz").value);fetch("/save_tz",{method:"POST",body:fd}).then(function(r){return r.text();}).then(function(t){document.getElementById("msg").textContent=t;});};
var doSaveBrightness=function(){var fd=new FormData();fd.append("brightness",document.getElementById("brightness").value);fetch("/save_brightness",{method:"POST",body:fd}).then(function(r){return r.text();}).then(function(t){document.getElementById("msg").textContent=t;});};
var loadStatus=function(){fetch("/api/status").then(function(r){return r.json();}).then(function(d){document.getElementById("deviceLabel").innerHTML="<b>"+escapeHtml(d.device_label||"Device")+"</b>";document.getElementById("settingsDeviceLabel").innerHTML="<b>"+escapeHtml(d.device_label||"Device")+"</b>";document.getElementById("ssidManual").value=d.saved_ssid||"";document.getElementById("brightness").value=d.brightness||42;document.getElementById("brightVal").textContent=d.brightness||42;document.getElementById("saveBtn").textContent=d.save_btn||"Save Settings";var tz=document.getElementById("tz");tz.innerHTML="";for(var i=0;i<TZ_LABELS.length;i++){var o=document.createElement("option");o.value=i;o.text=TZ_LABELS[i];if(i===(d.timezone_index||0))o.selected=true;tz.add(o);}}).catch(function(){});};
var escapeHtml=function(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML;};
var cToF=function(c){return (c*9/5)+32;};
var hpaToInHg=function(h){return h*0.02953;};
var getTempUnit=function(){var s=document.getElementById("tempUnit");return s?s.value:"C";};
var getPressureUnit=function(){var s=document.getElementById("pressureUnit");return s?s.value:"hPa";};
var formatTemp=function(tc){return getTempUnit()==="F"?cToF(tc).toFixed(1):tc.toFixed(1);};
var formatPressure=function(hpa){return getPressureUnit()==="inHg"?hpaToInHg(hpa).toFixed(2):Math.round(hpa);};
var tempLabel=function(){return getTempUnit()==="F"?"Temp 째F":"Temp 째C";};
var pressureLabel=function(){return getPressureUnit()==="inHg"?"inHg":"hPa";};
var loadLive=function(){fetch("/api/readings").then(function(r){return r.json();}).then(function(d){var el=document.getElementById("liveReadings");if(!d.valid){el.textContent="No sensor data";return;}var t=formatTemp(d.temp_c);var pu=getPressureUnit();var p=pu==="inHg"?hpaToInHg(d.pressure_hpa).toFixed(2):d.pressure_hpa;el.textContent="Temp: "+t+(getTempUnit()==="F"?" 째F":" 째C")+" | Humidity: "+d.humidity_pct+" % | Pressure: "+p+" "+(pu==="inHg"?"inHg":"hPa");}).catch(function(){document.getElementById("liveReadings").textContent="Failed to load";});};
var hChart=null;
var getHistoryRes=function(){var sel=document.getElementById("historyRes");return sel?sel.value:"hourly";};
var loadHistory=function(){var res=getHistoryRes();var tUnit=getTempUnit();var pUnit=getPressureUnit();var thT=document.getElementById("thTemp");var thP=document.getElementById("thPressure");if(thT)thT.textContent=tempLabel();if(thP)thP.textContent=pressureLabel();fetch("/api/history?res="+encodeURIComponent(res)).then(function(r){return r.json();}).then(function(arr){var valid=arr.filter(function(x){return x.valid;});var labels=valid.map(function(x){return new Date(x.timestamp*1000).toLocaleString();});if(hChart)hChart.destroy();var tempData=valid.map(function(x){return tUnit==="F"?cToF(x.temp_c):x.temp_c;});var pressData=valid.map(function(x){return pUnit==="inHg"?hpaToInHg(x.pressure_hpa):x.pressure_hpa;});var yMin=0;var yMax=50;if(tUnit==="F"){yMin=32;yMax=122;}var pMin=pUnit==="inHg"?28.9:980;var pMax=pUnit==="inHg"?30.8:1040;var ds1={label:tempLabel(),data:tempData,borderColor:"#ef4444",fill:false,tension:0.2};var ds2={label:"Humidity %",data:valid.map(function(x){return x.humidity_pct;}),borderColor:"#3b82f6",fill:false,tension:0.2,yAxisID:"y1"};var ds3={label:pressureLabel(),data:pressData,borderColor:"#22c55e",fill:false,tension:0.2,yAxisID:"y2"};var opts={responsive:true,maintainAspectRatio:false,scales:{y:{min:yMin,max:yMax},y1:{position:"right",min:0,max:100},y2:{position:"right",min:pMin,max:pMax}}};var cfg={type:"line",data:{labels:labels,datasets:[ds1,ds2,ds3]},options:opts};hChart=new Chart(document.getElementById("historyChart"),cfg);var tbody=document.getElementById("historyBody");tbody.innerHTML="";for(var i=Math.max(0,arr.length-24);i<arr.length;i++){var row=arr[i];if(!row.valid)continue;var dt=new Date(row.timestamp*1000);var txt=dt.toLocaleString();var tr=document.createElement("tr");tr.style.borderBottom="1px solid #2a3240";var td1=document.createElement("td");td1.style.padding="4px";td1.textContent=txt;var td2=document.createElement("td");td2.style.textAlign="right";td2.style.padding="4px";td2.textContent=formatTemp(row.temp_c);var td3=document.createElement("td");td3.style.textAlign="right";td3.style.padding="4px";td3.textContent=row.humidity_pct;var td4=document.createElement("td");td4.style.textAlign="right";td4.style.padding="4px";td4.textContent=formatPressure(row.pressure_hpa);tr.appendChild(td1);tr.appendChild(td2);tr.appendChild(td3);tr.appendChild(td4);tbody.appendChild(tr);}if(tbody.children.length===0){var tr=document.createElement("tr");var td=document.createElement("td");td.colSpan=4;td.textContent="No history yet";tr.appendChild(td);tbody.appendChild(tr);}}).catch(function(){var tbody=document.getElementById("historyBody");tbody.innerHTML="";var tr=document.createElement("tr");var td=document.createElement("td");td.colSpan=4;td.textContent="Failed to load";tr.appendChild(td);tbody.appendChild(tr);});};
var resEl=document.getElementById("historyRes");if(resEl)resEl.onchange=function(){loadHistory();};
var tempEl=document.getElementById("tempUnit");if(tempEl)tempEl.onchange=function(){loadLive();loadHistory();};
var pressureEl=document.getElementById("pressureUnit");if(pressureEl)pressureEl.onchange=function(){loadLive();loadHistory();};
loadStatus();loadLive();loadHistory();
setInterval(loadLive,5000);setInterval(loadHistory,60000);
